<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Virtual Oxidation Technician</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 16px/1.4 system-ui, sans-serif; margin: 2rem; max-width: 900px; }
    textarea, input, button { width: 100%; box-sizing: border-box; margin: 0.5rem 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    pre { background: #f6f8fa; padding: 0.75rem; overflow: auto; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Virtual Oxidation Technician</h1>
  <p>Submit your DOE as JSON. You’ll receive a CSV and preview plot.</p>

  <div class="card">
    <h3>JSON Template</h3>
    <pre>{
  "objective": "Hit 100 nm with minimal nonuniformity",
  "target": {"thickness_nm": 100, "tolerance_nm": 5},
  "design": {
    "strategy": "screening",
    "runs": [
      {"temp_C": 1000, "ambient": "dry", "time_min": 60, "orientation": "100", "preclean": true},
      {"temp_C": 1000, "ambient": "wet", "time_min": 20, "orientation": "100", "preclean": true}
    ]
  },
  "notes": "Budget: ≤ 3 runs today",
  "student_id": "abc123",
  "section": "ECSE 322/415 F25"
}</pre>
  </div>

  <label for="json">Your DOE JSON</label>
  <textarea id="json" rows="16"></textarea>

  <div class="row">
    <button id="submit">Run Experiments</button>
    <button id="fill">Fill Example</button>
  </div>

  <div id="result" class="card" style="display:none;">
    <h3>Results</h3>
    <p id="log"></p>
    <img id="plot" alt="Preview plot" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;" />
    <div class="row">
      <button id="downloadCsv">Download CSV</button>
      <button id="copyNote">Copy Tech Note</button>
    </div>
    <pre id="note"></pre>
  </div>

<script>
const API = "https://oxidation-api.onrender.com/run_experiments";; // <- set to your HTTPS endpoint

const $ = sel => document.querySelector(sel);
$("#fill").onclick = () => {
  $("#json").value = `{
  "objective": "Hit 100 nm with minimal nonuniformity",
  "target": {"thickness_nm": 100, "tolerance_nm": 5},
  "design": {
    "strategy": "screening",
    "runs": [
      {"temp_C": 1000, "ambient": "dry", "time_min": 60, "orientation": "100", "preclean": true},
      {"temp_C": 1000, "ambient": "wet", "time_min": 20, "orientation": "100", "preclean": true}
    ]
  },
  "notes": "Budget: ≤ 3 runs today",
  "student_id": "abc123",
  "section": "ECSE 322/415 F25"
}`;
};

$("#submit").onclick = async () => {
  let payload;
  try {
    payload = JSON.parse($("#json").value);
  } catch (e) {
    alert("Invalid JSON. Please fix and try again.");
    return;
  }

  const res = await fetch(API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const txt = await res.text();
    alert("Error from server:\n" + txt);
    return;
  }

  const data = await res.json();
  $("#result").style.display = "block";
  $("#log").textContent = data.run_log + "  (Result ID: " + data.uid + ")";
  $("#plot").src = "data:image/png;base64," + data.preview_plot_png_base64;
  $("#note").textContent = data.tech_note;

  // CSV download
  $("#downloadCsv").onclick = () => {
    const a = document.createElement("a");
    a.href = "data:text/csv;base64," + data.csv_base64;
    a.download = "oxidation_results.csv";
    a.click();
  };

  $("#copyNote").onclick = async () => {
    await navigator.clipboard.writeText(data.tech_note);
  };
};
</script>
</body>
</html>

