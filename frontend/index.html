<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Virtual Oxidation Technician</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 16px/1.4 system-ui, sans-serif; margin: 2rem; max-width: 900px; }
    textarea, button { width: 100%; box-sizing: border-box; margin: 0.5rem 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    pre { background: #f6f8fa; padding: 0.75rem; overflow: auto; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Virtual Oxidation Technician</h1>
  <p>Submit your DOE as JSON. You’ll receive a CSV, a 3×3 wafer-map CSV, and a preview plot.</p>

  <div class="card">
    <h3>JSON Template</h3>
    <pre>{
  "objective": "Hit 100 nm with minimal nonuniformity",
  "target": {"thickness_nm": 100, "tolerance_nm": 5, "initial_oxide_nm": 0},
  "design": {
    "strategy": "screening",
    "runs": [
      {"temp_C": 1000, "ambient": "dry", "time_min": 60, "orientation": "100", "preclean": true},
      {"temp_C": 1000, "ambient": "wet", "time_min": 20, "orientation": "100", "preclean": true}
    ]
  },
  "notes": "Budget: ≤ 3 runs today",
  "student_id": "abc123",
  "section": "ECSE 322/415 F25"
}</pre>
  </div>

  <label for="json">Your DOE JSON</label>
  <textarea id="json" rows="16"></textarea>

  <div class="row">
    <button id="submit">Run Experiments</button>
    <button id="fill">Fill Example</button>
  </div>

  <div id="result" class="card" style="display:none;">
    <h3>Results</h3>
    <p id="log"></p>
    <img id="plot" alt="Preview plot" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;" />
    <div class="row">
      <button id="downloadCsv">Download CSV</button>
      <button id="copyNote">Copy Tech Note</button>
    </div>
    <pre id="note"></pre>
    <!-- wafer image and extra buttons get added here dynamically -->
  </div>

  <!-- Keep this script right before </body> -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    /* ====== CONFIG ====== */
    const API   = "https://oxidation-api.onrender.com/run_experiments";   // your backend URL
    const TOKEN = "Oxide!2025!HW4";                                       // MUST equal LABTOKEN on Render; "" to disable

    /* ====== UTIL ====== */
    const $ = (sel) => document.querySelector(sel);
    function dl(name, href) { const a = document.createElement("a"); a.href = href; a.download = name; a.click(); }

    /* ====== ELEMENTS ====== */
    const box       = $("#json");
    const btnFill   = $("#fill");
    const btnSubmit = $("#submit");
    const result    = $("#result");
    const logEl     = $("#log");
    const plotImg   = $("#plot");
    const noteEl    = $("#note");
    const rowBtns   = document.querySelector("#result .row");
    const btnCsv    = $("#downloadCsv");
    const btnCopy   = $("#copyNote");

    /* ====== PREFILL / REMEMBER LAST ====== */
    const example = `{
      "objective": "Hit 100 nm with minimal nonuniformity",
      "target": {"thickness_nm": 100, "tolerance_nm": 5, "initial_oxide_nm": 0},
      "design": {
        "strategy": "screening",
        "runs": [
          {"temp_C": 1000, "ambient": "dry", "time_min": 60, "orientation": "100", "preclean": true},
          {"temp_C": 1000, "ambient": "wet", "time_min": 20, "orientation": "100", "preclean": true}
        ]
      },
      "notes": "Budget: ≤ 3 runs today",
      "student_id": "abc123",
      "section": "ECSE 322/415 F25"
    }`;
    if (btnFill) btnFill.onclick = () => { if (box) box.value = example; };
    if (box) box.value = localStorage.getItem("lastDOE") || box.value || example;

    /* ====== RUN ====== */
    if (btnSubmit) btnSubmit.onclick = async () => {
      // Parse JSON
      let payload;
      try { payload = JSON.parse(box.value); }
      catch { alert("Invalid JSON. Fix and try again."); return; }

      // Remember last JSON
      localStorage.setItem("lastDOE", box.value);

      // Build headers
      const headers = { "Content-Type": "application/json" };
      if (TOKEN) headers["x-labtoken"] = TOKEN;

      // Call API
      let res, text;
      try {
        res  = await fetch(API, { method: "POST", headers, body: JSON.stringify(payload) });
        text = await res.text();
      } catch (e) { alert("Network error: " + e); return; }

      if (!res.ok) {
        if (res.status === 401) alert("401 invalid token. TOKEN must match LABTOKEN on the backend.");
        else if (res.status === 429) alert("Rate limit: too many submissions. Try again later.");
        else alert(`Error ${res.status}:\n${text}`);
        return;
      }

      let data;
      try { data = JSON.parse(text); } catch { alert("Bad JSON from server."); return; }

      // Reveal results
      if (result) result.style.display = "block";
      if (logEl)  logEl.textContent  = `${data.run_log}  (Result ID: ${data.uid})`;
      if (noteEl) noteEl.textContent = data.tech_note || "";
      if (plotImg) plotImg.src = "data:image/png;base64," + (data.preview_plot_png_base64 || "");

      // Download CSV (summary)
      if (btnCsv) btnCsv.onclick = () =>
        dl("oxidation_results.csv", "data:text/csv;base64," + (data.csv_base64 || ""));

      // Copy tech note
      if (btnCopy) btnCopy.onclick = async () => {
        try { await navigator.clipboard.writeText(data.tech_note || ""); } catch {}
      };

      // Add "Download 3×3 Map CSV" button once
      if (rowBtns && !document.getElementById("downloadMapCsv")) {
        const btn = document.createElement("button");
        btn.id = "downloadMapCsv";
        btn.textContent = "Download 3×3 Map CSV";
        btn.style.width = "100%";
        rowBtns.appendChild(btn);
      }
      const btnMap = document.getElementById("downloadMapCsv");
      if (btnMap) btnMap.onclick = () =>
        dl("oxidation_wafer_maps.csv", "data:text/csv;base64," + (data.map_csv_base64 || ""));

      // Add "Download Plot" button once
      if (rowBtns && !document.getElementById("downloadPlot")) {
        const btn = document.createElement("button");
        btn.id = "downloadPlot";
        btn.textContent = "Download Plot";
        btn.style.width = "100%";
        rowBtns.appendChild(btn);
      }
      const btnPlot = document.getElementById("downloadPlot");
      if (btnPlot) btnPlot.onclick = () =>
        dl("center_thickness_plot.png", "data:image/png;base64," + (data.preview_plot_png_base64 || ""));

      // Wafer-map image + download
      if (data.wafer_maps_png_base64) {
        let img = document.getElementById("waferMapsImg");
        if (!img) {
          img = document.createElement("img");
          img.id = "waferMapsImg";
          img.style.maxWidth = "100%";
          img.style.border = "1px solid #ddd";
          img.style.borderRadius = "8px";
          img.style.marginTop = "12px";
          result.appendChild(img);
        }
        img.src = "data:image/png;base64," + data.wafer_maps_png_base64;

        if (rowBtns && !document.getElementById("downloadWaferMaps")) {
          const btn = document.createElement("button");
          btn.id = "downloadWaferMaps";
          btn.textContent = "Download Wafer Maps PNG";
          btn.style.width = "100%";
          rowBtns.appendChild(btn);
        }
        const btnWM = document.getElementById("downloadWaferMaps");
        if (btnWM) btnWM.onclick = () =>
          dl("wafer_maps.png", "data:image/png;base64," + data.wafer_maps_png_base64);
      }
    }; // end submit
  }); // end DOMContentLoaded
  </script>
</body>
</html>
